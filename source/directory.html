<!DOCTYPE HTML>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Content-type" content="text/html; charset=utf-8">
		<title>AMWA</title>
		<link rel="stylesheet" href="css/jquery.mobile-1.4.5.min.css">
		<link rel="stylesheet" href="css/style.css" />
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/jquery.mobile-1.4.5.min.js"></script>
		<script src="main.js"></script>
	<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
	</head>

<body>

<div id="directoryPage" data-role="page" data-theme="a"  >
	
	<div data-role="header" data-position="fixed" data-theme="b">
		
			

			 <a href="#mypanel" class="ui-btn ui-btn-inline ui-icon-menu-bars ui-btn-icon-notext ui-corner-all ui-shadow ui-nodisc-icon" style="background-color:#E68538;border:none">Without circle</a>
			 <a href="javascript:GoAdmin()" class="ui-btn ui-btn-inline ui-icon-gears ui-btn-icon-notext ui-corner-all ui-shadow ui-nodisc-icon" style="background-color:#E68538;border:none;margin-right:5px">Without circle</a>   
		
		
		<h6>Atlantic Metal Working Association</h6>
	</div>

	<div data-role="content" >
		
		
		
		
		
		
					
		<ul id="company-list"  data-role="listview" data-filter="true" data-inset="false" data-theme="a" class="animClass" data-icon="next" ></ul>
		<p style="text-align:center;margin-top:100px" id="loading"><img src="images/ajax-loader.gif" /></p>
			
	</div><!-- content -->


	

	<div data-role="panel" id="filter-panel" data-position="left" data-display="overlay" data-theme="a">
    	<!-- panel content goes here -->
    		<form id="frm-search">
		
			
			<select name="ddl-province" id="ddl-province" onchange="GetCities()" data-mini="true" style="border:none" ></select>
			
			<select name="ddl-city" id="ddl-city" data-mini="true"  ></select>
			  
			<div id="cg-services" ></div>
			
			<button type="submit" id="btn-search" data-mini="true" data-rel="close">Apply Filters</button>
				
		</form>
		</div><!-- /panel -->


	<div data-role="footer" data-position="fixed">
		<div data-role="navbar">
			<ul>
				
				<li>
					<a href="#filter-panel" class="ui-link ui-btn ui-icon-filter ui-btn-icon-top ui-shadow ui-corner-all ui-btn-active ui-nodisc-icon" style="background-color:#E68538;border:none"></a> 
				</li>
				
			</ul>
		</div>
	</div><!-- footer -->

	<div data-role="panel" data-position="left" data-position-fixed="false" data-display="reveal" id="mypanel" data-theme="a">
		<p style="text-align:center"><img src="images/mcf.png" width="70%" /></p>
		<div style="height:20px"></div>
		<ul data-role="listview" data-filter="false" data-theme="a" data-inset="false">
			<li>
				<a href="wods.html" data-rel="close" class="ui-btn ui-shadow ui-btn-b ui-icon-mcfit ui-btn-icon-right" data-ajax="false">WODs</a>
			</li>
		</ul>
	</div><!-- /panel -->

	<script type="text/javascript">
	
		$(document).delegate("#directoryPage", "pagebeforeshow", function() {
			$("#loading").show();
						
			if($('#ddl-province').children('option').length <= 0){
				//GetProvinces();
			}
			
		
			//GetServices();
			
			
			
			if($('#company-list li').size() <= 0){
			$("#company-list").empty();
			var name = "";
			var html = "";
			var xml = window.localStorage.getItem("ML");
			xmlDoc = $.parseXML(xml);
			$xml = $(xmlDoc);
			$xml.find("company").each(function() {
				var id = $(this).find('id').text();
				
				name = $(this).find('name').text();
				var address = decodeURI($(this).find('address').text());
				
				
				
				$("#company-list").append("<li><a data-ajax='false' href='javascript:GoCompany(" + id + ")'>" + name + "<br >" + address + "</a></li>");
				$('#company-list').listview('refresh');
				
				
			});
			}
			
			$("#loading").hide();
			
			
		});
		
		
				
		function GetProvinces(){
			
			$("#ddl-province").empty();
			$("#ddl-province").append("<option value='-1'>Select a Province</option>");
			var html = "";
			var xml = window.localStorage.getItem("PROV");	
			xmlDoc = $.parseXML(xml);
			$xml = $(xmlDoc);
			$xml.find("province").each(function() {
				var id = $(this).find('id').text();
				var name = $(this).find('name').text();
			    $("#ddl-province").append("<option value='" + id + "'>" + name + "</option>");
		
			});
		
			$("#ddl-province").selectmenu("refresh");
						
			
		}
				
				function GetCities(){
					var prov = $("#ddl-province").val();
					
					$.ajax({
							type : "POST",
							url : "http://mycfit.ca/site_amwa_services/get_cities.php",
							async: false,
							data : {'prov' : prov},
							dataType : "json",
							success : function(data) {
								
								if(data.count > 0){
									
									$("#ddl-city").empty();
									$("#ddl-city").append("<option value='-1'>Select a City</option>");
									var html = "";
									var xml = data.result;
									xmlDoc = $.parseXML(xml);
									$xml = $(xmlDoc);
									$xml.find("city").each(function() {
										
										var id = $(this).find('id').text();
										var name = $(this).find('name').text();
										
									    $("#ddl-city").append("<option value='" + id + "'>" + decodeURI(name) + "</option>");
								
									});
								
									$("#ddl-city").selectmenu("refresh");
								}
								
							},
							error : function(xhr, errorType, exception) {
								alert(xhr + errorType + exception);
							}
						});
				}
			
				function GetServices(){
					
					$("#cg-services").html("");
					var html = "";
					var xml = window.localStorage.getItem("SERVICES");
					xmlDoc = $.parseXML(xml);
					$xml = $(xmlDoc);
					$xml.find("service").each(function() {
						
						var id = $(this).find('id').text();
						var name = $(this).find('name').text();
						$("#cg-services").append("<label for='chk" + id + "'>" + name + "</label><input type='checkbox' id='chk" + id + "' name='chk" + id + "' data-mini='true' onchange='ShowSubs(" + id + ")'></input>");
						$("#chk" + id).checkboxradio();
						
						$("#cg-services").append("<div id='sub" + id + "' style='display:none'>");
						var subs =  $(this).find('subs').html();
						xmlDoc2 = $.parseXML(subs);
						$subs = $(xmlDoc2);
						$subs.find("sub").each(function() {
							var sid = $(this).find('sub_id').text();
							var sname = $(this).find('sub_name').text();
							$("#cg-services").append("<label id='lbl-" + id + "-" + sid + "' class='lblsub lbl-" + id + "' lbl style='display:none' for='chk-" + id + "-" + sid + "'>" + sname + "</label><input class='chksub chk-" + id + "' style='display:none' type='checkbox' id='chk-" + id + "-" + sid + "' name='chk-" + id + "-" + sid + "' data-mini='true'></input>");
							$("#chk-" + id + "-" + sid).checkboxradio();
						});
						$("#cg-services").append("</div>");
					});
					//$("#cg-services").controlgroup( "refresh" );
											
				}
				
				$('#frm-search').submit(function (e) {
					$("#loading").show();
				    e.preventDefault();
				    Search();
				});

				function ShowSubs(id){
					if ($("#chk" + id).is(':checked')) {
						$(".lbl-" + id).show();
					$(".chk-" + id).show();
					}else{
						
						  $("input.chk-" + id).each(function(i) 
					    	{
					    		
					    		$("#" + this.id).prop('checked', false);
					    		$("#" + this.id).checkboxradio();
					          
					      
					          
					    	});   
					    	
					    	$("label.lbl-" + id).each(function(i) 
					    	{
					    		
					    		
					         
					            $("#" + this.id).removeClass("ui-checkbox-on");
					    		$("#" + this.id).addClass("ui-checkbox-off");
					          
					    	});   
					                 
					                
						
						
						$(".lbl-" + id).hide();
					$(".chk-" + id).hide();
					}
				
					
				}
				
				function Search(){
					
					var form = $("#frm-search");
					$('#company-list').empty();
					$.ajax({
							type : "POST",
							url : "http://mycfit.ca/site_amwa_services/get_companies.php",
							async: false,
							data : form.serialize(),
							dataType : "json",
							success : function(data) {
								
								var name = "";
								var html = "";
								var xml = data.result;
								xmlDoc = $.parseXML(xml);
								$xml = $(xmlDoc);
								$xml.find("company").each(function() {
									var id = $(this).find('id').text();
									
									name = $(this).find('name').text();
									var address = $(this).find('address').text();
									
									
									
									$("#company-list").append("<li><a href='javascript:GoCompany(" + id + ")'>" + name + "<br >" + address + "</a></li>");
								});
								$("#loading").hide();
								
								
								
								
								
								$('#company-list').listview('refresh');				
							},
							error : function(xhr, errorType, exception) {
								alert("Search" + xhr + errorType + exception);
							}
						}); 
					 
				}
	       
	       function GoCompany(id){
	       	window.localStorage.setItem("CID", id);
	       	window.location = "company.html";
	        //$.mobile.changePage( "company.html", { transition: "slid", changeHash: false, reloadPage: true });
	       }
	       
	       function GoAdmin(){
	       	
	       	window.location = "admin.html";
	       }
			

			</script>			

</div>

	</body>
</html>
